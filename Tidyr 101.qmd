---
title: "Tidyr-101"
author : "Daphn√© Perry"
format: 
  html: default
  pdf : default 
---

```{r}
here::i_am("git-101.Rproj")
library(here)
```

```{r}
#| message: false
library(ggplot2)
library(dplyr)
library(tidyr)
```

```{r}
data("EuStockMarkets")
```

## Displaying one time series
Lets first show the evolution of the DAX: 
 
```{r}
ggplot(EuStockMarkets, aes(y = DAX, x = time(EuStockMarkets)))+
  geom_line()
```
Here we apply the time function to the data frame, bcs we donc have a date/the time on the dataframe (bcs in fact its a data frame of time series, so the 4 time series are collected at the same date).
Ggplot is complaining a bit, bcs u need an additionnal package to leverage the time series w/ ggplot. 

So now, to do that cleanly: 
```{r}
EuStockMarkets <-
  EuStockMarkets |> 
    as_tibble() |> ## could be as.data.frame 
    mutate(date = as.numeric(time(EuStockMarkets)))
```

Now lets try again the graph rpztation
```{r}
ggplot(EuStockMarkets, aes(y = DAX, x = date))+
  geom_line()
```

Now, if we'd like to have also the CaC on the same graph, here to have it alone : 
```{r}
ggplot(EuStockMarkets, aes(y = CAC, x = date))+
  geom_line()
```

## Two indexes on the same grpah rpztation
So here we try to have DAX & CAC on the same graph rpztation

### Poor man's solution

```{r}
ggplot(EuStockMarkets, aes(y = CAC, x = date))+   # here we tell the dataframe we're working on & the mapping, that's the 1st graph rpztation
  geom_line(color="forestgreen")+  # we can add as many geom_line as we want
  geom_line(mapping = aes(y=DAX), color="darkred")   #don't modif the x, bcs we already mapped it in the 1st line
```
There is no way to automate that if we use this type of solution (ex : if 20 type of data, have to make 20 geom_line = relou)


### Tidyr solution
The prbl we are facing is in fact simple, in the sens that its caused by the fact that the date is in wide format (= situation where u have a large nb of columns, cad each of the object (here the date) is described by multiple variables). Its not adapted in ggplot, bcs it normally prefers long format (where a object is spreaded in multiple rows, instead of multiple columns). 
Ex of long format :

| Center | Center | Center |
|:------:|:------:|:------:|
| date   | name   | value  |
| 1991   | DAX    | ...    |
| 1991   | CAC    | ...    |
| 1991   | SMI    | ...    |
| 1991   | FTSE   | ...    |

2 main functions in tidyr : pivot longer / pivot wider (= pivot smthing in long format to wide format)
```{r}
EuStockMarkets |>     ## this is a classical dataframe, but prbl = the mapping in ggplot is columnwise (can't ask for a plot of subsets of columns ->to do that, use pivoting)
  pivot_longer(!date, names_to = "index") |>
  slice_head(n=10) |>
  knitr::kable()
```
In this direction of pivoting, essentially we say to pivot longer, we could ask to pivot everything (even if useless in this setting): 
```{r}
EuStockMarkets|>
  pivot_longer(everything()) |>
  slice_head(n=10) |>
  knitr::kable()
```
This is a very bad pivoting bcs I cannot go back to the original dataframe. That's why need to pivot over an index. 
Now let's pivot on the DAX and on the SMI: 
```{r}
EuStockMarkets|>
  pivot_longer(DAX | SMI) |>   #twisted to do that, only if data is very oddly formated. 
  slice_head(n=10) |>
  knitr::kable()
```



```{r}
EuStockMarkets |>        
  pivot_longer(!date, names_to = "index") |>
  ggplot(aes(x = date, y = value, color=index))+
  geom_line()
```
Great, we have a legend (automatically). 
Longer is mostly used too do graphs like that but also to do stats w/out using across. 
### More pivoting

Lets say I want to compute the average of the indexes (even if that doesn't really makes sens here: we know how to operate on 1 column, how to do the same function on multiple columns, but we don't know how to do yet on a row ->possible to use roow wise, but also can use pivoting! 
Pivot could be useful in computing the average of the first 3 markets. The trick is when u pivot, then suddently something that was column oriented becomes column oriented. 

#### Working on rows with pivoting
```{r}
EuStockMarkets|>
  select(!FTSE)|> #we don't want to include the FTSE
  pivot_longer(!date)|> #we want to pivot everything except the date
  summarise(avg_stock=mean(value), .by = date) |> #there we don't get the average mean but the mean by date!
  slice_head(n=10) |>
  knitr::kable()
```







